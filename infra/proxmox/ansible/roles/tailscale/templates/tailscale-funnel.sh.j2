#!/bin/bash
# Tailscale Funnel Configuration Script
# Generated by Ansible for {{ inventory_hostname }}
# This script configures Tailscale Funnel to expose services publicly

set -e

echo "Configuring Tailscale Funnel for {{ tailscale_hostname }}..."

# Reset existing configuration
echo "Resetting existing Tailscale Serve/Funnel configuration..."
tailscale serve reset || true

{% if tailscale_funnel_config | length > 0 %}
# Configure Serve endpoints for Funnel
echo "Configuring Tailscale Serve endpoints..."
{% for endpoint in tailscale_funnel_config %}
echo "  - Setting up HTTPS:{{ endpoint.port }} -> localhost:{{ endpoint.target_port }}"
tailscale serve https:{{ endpoint.port }} / {{ endpoint.target_port }}
{% endfor %}

# Enable Funnel for each port
echo "Enabling Tailscale Funnel for public access..."
{% for endpoint in tailscale_funnel_config %}
echo "  - Enabling Funnel on port {{ endpoint.port }}"
tailscale funnel {{ endpoint.port }} on
{% endfor %}
{% else %}
echo "No Funnel endpoints configured."
{% endif %}

# Display current status
echo ""
echo "Current Tailscale Funnel status:"
tailscale funnel status

echo ""
echo "Configuration complete!"
{% if tailscale_funnel_config | length > 0 %}
echo "Public URLs:"
{% for endpoint in tailscale_funnel_config %}
echo "  - https://{{ tailscale_hostname }}.{{ tailscale_domain }}:{{ endpoint.port }}"
{% endfor %}
{% endif %}
