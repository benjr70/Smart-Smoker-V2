# This is a basic workflow to help you get started with Actions
name: Cloud Deploy

on:
  workflow_call:
    inputs:
      version:
        description: 'version to release'
        type: string
        required: true

jobs:
  deploy:
    runs-on:
      SmokeCloud
      # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - run: sudo chmod -R 777 ./
      - uses: actions/checkout@v4

      # Pre-deployment backup
      - name: Backup current deployment
        run: |
          sudo mkdir -p /opt/smart-smoker/backups/deployments
          sudo ./scripts/deployment-backup.sh

      # URL-encode MongoDB password for connection string
      - name: URL-encode MongoDB password
        id: encode_password
        run: |
          ENCODED_PASSWORD=$(printf %s "${{ secrets.MONGO_APP_PASSWORD }}" | jq -sRr @uri)
          echo "ENCODED_MONGO_APP_PASSWORD=$ENCODED_PASSWORD" >> $GITHUB_ENV

      - name: docker pull
        env:
          VERSION: ${{ inputs.version }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
          VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
          MONGO_ROOT_USER: admin
          MONGO_ROOT_PASSWORD: ${{ secrets.MONGO_ROOT_PASSWORD }}
          MONGO_APP_PASSWORD: ${{ secrets.MONGO_APP_PASSWORD }}
          ENCODED_MONGO_APP_PASSWORD: ${{ env.ENCODED_MONGO_APP_PASSWORD }}
        run: sudo -E docker compose -f cloud.docker-compose.yml pull

      - name: docker build
        env:
          VERSION: ${{ inputs.version }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
          VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
          MONGO_ROOT_USER: admin
          MONGO_ROOT_PASSWORD: ${{ secrets.MONGO_ROOT_PASSWORD }}
          MONGO_APP_PASSWORD: ${{ secrets.MONGO_APP_PASSWORD }}
          ENCODED_MONGO_APP_PASSWORD: ${{ env.ENCODED_MONGO_APP_PASSWORD }}
        run: sudo -E docker compose -f cloud.docker-compose.yml build

      - name: docker compose down
        env:
          VERSION: ${{ inputs.version }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
          VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
          MONGO_ROOT_USER: admin
          MONGO_ROOT_PASSWORD: ${{ secrets.MONGO_ROOT_PASSWORD }}
          MONGO_APP_PASSWORD: ${{ secrets.MONGO_APP_PASSWORD }}
          ENCODED_MONGO_APP_PASSWORD: ${{ env.ENCODED_MONGO_APP_PASSWORD }}
        run: sudo -E docker compose -f cloud.docker-compose.yml down

      - name: Pre-deployment Docker cleanup
        run: |
          echo "Cleaning up old Docker resources before deployment..."
          # Prune unused images (not volumes - those contain persistent data)
          sudo docker image prune -af || true
          # Prune unused build cache
          sudo docker builder prune -af || true
          # Prune stopped containers
          sudo docker container prune -f || true
          # Show disk space after cleanup
          echo "Disk usage after cleanup:"
          df -h /var/lib/docker || df -h /

      - name: kill tailscale
        run: sudo systemctl stop tailscaled

      - name: docker compose up
        env:
          VERSION: ${{ inputs.version }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
          VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
          MONGO_ROOT_USER: admin
          MONGO_ROOT_PASSWORD: ${{ secrets.MONGO_ROOT_PASSWORD }}
          MONGO_APP_PASSWORD: ${{ secrets.MONGO_APP_PASSWORD }}
          ENCODED_MONGO_APP_PASSWORD: ${{ env.ENCODED_MONGO_APP_PASSWORD }}
        run: sudo -E docker compose -f cloud.docker-compose.yml up -d --force-recreate

      - name: start tailscale
        run: sudo systemctl start tailscaled

      # NEW: Wait for services to start (health checks have start_period of 60s)
      - name: Wait for startup
        run: sleep 60

      # NEW: Health check with retry (3x per user preference)
      - name: Verify deployment health
        id: health_check
        run: |
          if ! ./scripts/deployment-health-check.sh localhost 3; then
            echo "Health check failed after 3 retries"
            exit 1
          fi

      # NEW: Rollback on failure
      - name: Rollback on failure
        if: failure() && steps.health_check.outcome == 'failure'
        run: |
          echo "üö® Deployment failed health check, initiating rollback..."
          sudo ./scripts/rollback.sh

          # Verify rollback success
          sleep 30
          if ./scripts/deployment-health-check.sh localhost 1; then
            echo "‚úÖ Rollback successful, system restored"
          else
            echo "üí• Rollback failed - MANUAL INTERVENTION REQUIRED"
            exit 1
          fi

      # Modified: Only prune if deployment successful
      - name: docker compose remove old containers
        if: success()
        run: sudo docker system prune -a --volumes --force

      # NEW: Deployment notification
      - name: Deployment status notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful: version ${{ inputs.version }}"
          else
            echo "‚ùå Deployment failed and rolled back"
          fi
